{% extends 'base.html' %}

{% block title %}{% if action == 'edit' %}Edit Blog Post{% else %}Create New Blog Post{% endif %} - TBZ Blogs{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="mb-5">
                {% if action == 'edit' %}
                    <h1 class="display-5 fw-bold">
                        <i class="bi bi-pencil"></i> Edit Blog Post
                    </h1>
                    <p class="lead text-muted">Update your blog post content</p>
                {% else %}
                    <h1 class="display-5 fw-bold">
                        <i class="bi bi-plus-circle"></i> Create New Blog Post
                    </h1>
                    <p class="lead text-muted">Share your thoughts with the world</p>
                {% endif %}
            </div>

            <!-- AI Blog Generation Modal -->
            <div class="modal fade" id="aiGenerateBlogModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h5 class="modal-title text-white">
                                <i class="bi bi-stars"></i> Generate Blog with AI
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">Let AI create a blog post from your idea. It will generate title, excerpt, and content.</p>
                            <form id="aiGenerateForm">
                                <div class="mb-3">
                                    <label for="aiIdea" class="form-label fw-bold">Your Idea or Topic</label>
                                    <textarea class="form-control" id="aiIdea" placeholder="Describe your blog idea (e.g., 'How to build a REST API with Django')" rows="3" required></textarea>
                                    <small class="text-muted">Be specific about the topic for better results</small>
                                </div>
                                <div class="mb-3">
                                    <label for="aiLength" class="form-label fw-bold">Blog Length</label>
                                    <select class="form-select" id="aiLength" required>
                                        <option value="">Select length...</option>
                                        <option value="short">Short (500-700 words)</option>
                                        <option value="medium">Medium (800-1200 words)</option>
                                        <option value="long">Long (1500+ words)</option>
                                    </select>
                                </div>
                                <div id="aiGenerateLoading" class="d-none">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Generating blog with AI...</span>
                                </div>
                                <div id="aiGenerateError" class="alert alert-danger d-none" role="alert"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="aiGenerateBtn" onclick="generateBlogWithAI()">
                                <i class="bi bi-lightning-fill"></i> Generate Blog
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Enhance Content Modal -->
            <div class="modal fade" id="aiEnhanceModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <h5 class="modal-title text-white">
                                <i class="bi bi-wand2"></i> Enhance Content
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">Improve your content with different tones and styles.</p>
                            <form id="aiEnhanceForm">
                                <div class="mb-3">
                                    <label for="aiEnhanceStyle" class="form-label fw-bold">Content Style</label>
                                    <select class="form-select" id="aiEnhanceStyle" required>
                                        <option value="">Select style...</option>
                                        <option value="professional">Professional</option>
                                        <option value="funny">Funny & Engaging</option>
                                        <option value="casual">Casual & Friendly</option>
                                        <option value="academic">Academic & Formal</option>
                                        <option value="engaging">More Engaging</option>
                                    </select>
                                </div>
                                <div id="aiEnhanceLoading" class="d-none">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Enhancing content...</span>
                                </div>
                                <div id="aiEnhanceError" class="alert alert-danger d-none" role="alert"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="aiEnhanceBtn" onclick="enhanceContent()">
                                <i class="bi bi-lightning-fill"></i> Enhance
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Translate Content Modal -->
            <div class="modal fade" id="aiTranslateModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <h5 class="modal-title text-white">
                                <i class="bi bi-translate"></i> Translate Content
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">Translate your blog content to another language.</p>
                            <form id="aiTranslateForm">
                                <div class="mb-3">
                                    <label for="aiTranslateLanguage" class="form-label fw-bold">Target Language</label>
                                    <input type="text" class="form-control" id="aiTranslateLanguage" placeholder="e.g., Spanish, French, German, Hindi, Arabic" required>
                                    <small class="text-muted">Enter the language name</small>
                                </div>
                                <div id="aiTranslateLoading" class="d-none">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Translating content...</span>
                                </div>
                                <div id="aiTranslateError" class="alert alert-danger d-none" role="alert"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="aiTranslateBtn" onclick="translateContent()">
                                <i class="bi bi-lightning-fill"></i> Translate
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <!-- AI Tools Bar -->
                    {% if action == 'create' %}
                    <div class="alert alert-light border-2" role="alert" style="border-color: #667eea;">
                        <h6 class="mb-3">
                            <i class="bi bi-stars text-warning"></i> AI-Powered Tools
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#aiGenerateBlogModal">
                                <i class="bi bi-magic"></i> Generate Blog with AI
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if action == 'edit' %}
                    <div class="alert alert-light border-2" role="alert" style="border-color: #f5576c;">
                        <h6 class="mb-3">
                            <i class="bi bi-stars text-warning"></i> AI-Powered Tools
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#aiEnhanceModal">
                                <i class="bi bi-wand2"></i> Enhance Content
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#aiTranslateModal">
                                <i class="bi bi-translate"></i> Translate
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <!-- Title Field -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-type"></i> Title
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.title.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted d-block mt-2">
                                Enter a compelling title for your blog post (5-200 characters)
                            </small>
                        </div>

                        <!-- Slug Field -->
                        <div class="mb-4">
                            <label for="{{ form.slug.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-link-45deg"></i> URL Slug
                            </label>
                            {{ form.slug }}
                            <small class="form-text text-muted d-block mt-2">
                                Auto-generated from title. Used in the blog URL.
                            </small>
                        </div>

                        <!-- Excerpt Field -->
                        <div class="mb-4">
                            <label for="{{ form.excerpt.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-file-text"></i> Excerpt
                            </label>
                            {{ form.excerpt }}
                            {% if form.excerpt.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.excerpt.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted d-block mt-2">
                                Brief summary shown in blog list (10-500 characters, optional)
                            </small>
                        </div>

                        <!-- Featured Image Field -->
                        <div class="mb-4">
                            <label for="{{ form.featured_image.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-image"></i> Featured Image
                            </label>
                            {{ form.featured_image }}
                            {% if form.featured_image.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.featured_image.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted d-block mt-2">
                                Upload a cover image for your blog post (recommended: 1200x600px)
                            </small>

                            <!-- Show current image if editing -->
                            {% if blog.featured_image %}
                                <div class="mt-3">
                                    <strong>Current Image:</strong><br>
                                    <img src="{{ blog.featured_image.url }}" alt="Current featured image" class="img-thumbnail mt-2" style="max-width: 300px;">
                                </div>
                            {% endif %}
                        </div>

                        <!-- Content Field -->
                        <div class="mb-4">
                            <label for="{{ form.content.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-pencil-square"></i> Content
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.content.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted d-block mt-2">
                                Write your main blog content here. Minimum 50 characters. Supports HTML.
                            </small>

                            <!-- Content Tips -->
                            <div class="alert alert-info mt-3" role="alert">
                                <h6 class="alert-heading">
                                    <i class="bi bi-lightbulb"></i> Tips for Great Content
                                </h6>
                                <ul class="small mb-0">
                                    <li>Start with an engaging introduction</li>
                                    <li>Use headings and subheadings for structure</li>
                                    <li>Break content into short paragraphs</li>
                                    <li>Include code snippets with proper formatting</li>
                                    <li>Add links to relevant resources</li>
                                    <li>Proofread before publishing</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Category Field -->
                        <div class="mb-4">
                            <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-tag"></i> Category/Tags
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.category.errors }}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted d-block mt-2">
                                Comma-separated categories/tags to classify your post (e.g., Python, Django, Web Development)
                            </small>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex gap-2 mt-5">
                            {% if action == 'edit' %}
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="bi bi-check-circle"></i> Update Blog Post
                                </button>
                                <a href="{% url 'blog_detail' slug=blog.slug %}" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            {% else %}
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="bi bi-plus-circle"></i> Create Blog Post
                                </button>
                                <a href="{% url 'blog_list' %}" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-4" role="alert">
                <i class="bi bi-info-circle"></i>
                <strong>Note:</strong> Your blog post will be saved as a draft. You can review it before publishing.
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-generate slug from title
    document.getElementById('id_title').addEventListener('input', function() {
        const title = this.value;
        const slug = title
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
        document.getElementById('id_slug').value = slug;
    });

    // Generate Blog with AI
    async function generateBlogWithAI() {
        const idea = document.getElementById('aiIdea').value.trim();
        const length = document.getElementById('aiLength').value;

        if (!idea || !length) {
            alert('Please fill in all fields');
            return;
        }

        const btn = document.getElementById('aiGenerateBtn');
        const loading = document.getElementById('aiGenerateLoading');
        const errorDiv = document.getElementById('aiGenerateError');

        btn.disabled = true;
        loading.classList.remove('d-none');
        errorDiv.classList.add('d-none');

        try {
            const response = await fetch('{% url "api_generate_blog" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    idea: idea,
                    length: length
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate blog');
            }

            // Populate form fields with generated content
            document.getElementById('id_title').value = data.title;
            document.getElementById('id_slug').value = data.title
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
            document.getElementById('id_excerpt').value = data.excerpt;
            document.getElementById('id_content').value = data.content;

            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiGenerateBlogModal'));
            modal.hide();

            alert('Blog generated successfully! Review and edit if needed.');
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            loading.classList.add('d-none');
        }
    }

    // Enhance Content
    async function enhanceContent() {
        const content = document.getElementById('id_content').value.trim();
        const style = document.getElementById('aiEnhanceStyle').value;

        if (!content) {
            alert('Please write some content first');
            return;
        }

        if (!style) {
            alert('Please select an enhancement style');
            return;
        }

        const btn = document.getElementById('aiEnhanceBtn');
        const loading = document.getElementById('aiEnhanceLoading');
        const errorDiv = document.getElementById('aiEnhanceError');

        btn.disabled = true;
        loading.classList.remove('d-none');
        errorDiv.classList.add('d-none');

        try {
            const response = await fetch('{% url "api_enhance_content" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    content: content,
                    style: style
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to enhance content');
            }

            // Show comparison and ask to replace
            const comparison = `
ORIGINAL READABILITY: ${data.readability_score.original_score}/100
ENHANCED READABILITY: ${data.readability_score.enhanced_score}/100

IMPROVEMENTS:
${data.improvements.join('\n')}

---

ENHANCED CONTENT:
${data.enhanced_content}
            `;

            if (confirm('Content enhanced! Click OK to replace your content, or Cancel to keep original.')) {
                document.getElementById('id_content').value = data.enhanced_content;
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiEnhanceModal'));
                modal.hide();
                alert('Content updated successfully!');
            }
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            loading.classList.add('d-none');
        }
    }

    // Translate Content
    async function translateContent() {
        const content = document.getElementById('id_content').value.trim();
        const language = document.getElementById('aiTranslateLanguage').value.trim();

        if (!content) {
            alert('Please write some content first');
            return;
        }

        if (!language) {
            alert('Please specify a target language');
            return;
        }

        const btn = document.getElementById('aiTranslateBtn');
        const loading = document.getElementById('aiTranslateLoading');
        const errorDiv = document.getElementById('aiTranslateError');

        btn.disabled = true;
        loading.classList.remove('d-none');
        errorDiv.classList.add('d-none');

        try {
            const response = await fetch('{% url "api_translate_content" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    content: content,
                    language: language
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to translate content');
            }

            // Show translation and ask to replace
            const translation = `
LANGUAGE: ${data.language}

TRANSLATED CONTENT:
${data.translated_content}

TRANSLATION NOTES:
${data.translation_notes || 'No additional notes'}
            `;

            if (confirm(`Content translated to ${data.language}! Click OK to replace your content, or Cancel to keep original.`)) {
                document.getElementById('id_content').value = data.translated_content;
                const modal = bootstrap.Modal.getInstance(document.getElementById('aiTranslateModal'));
                modal.hide();
                alert('Content updated successfully!');
            }
        } catch (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            loading.classList.add('d-none');
        }
    }
</script>
{% endblock %}
