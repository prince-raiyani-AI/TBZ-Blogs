{% extends 'base.html' %}
{% load static %}

{% block title %}{{ blog.title }} - Analytics - TBZ Blogs{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-2">ğŸ“Š Blog Analytics: {{ blog.title }}</h1>
            <p class="text-muted">Detailed performance and engagement metrics</p>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-2">Views</h6>
                    <h3 class="mb-0">{{ views }}</h3>
                    <small class="text-muted">ğŸ‘ï¸ Page views</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-danger">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-2">Likes</h6>
                    <h3 class="mb-0">{{ likes }}</h3>
                    <small class="text-muted">â¤ï¸ Engagement</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-2">Comments</h6>
                    <h3 class="mb-0">{{ comments_count }}</h3>
                    <small class="text-muted">ğŸ’¬ Reader feedback</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <h6 class="card-title text-muted mb-2">Engagement Rate</h6>
                    <h3 class="mb-0">{{ engagement_rate }}%</h3>
                    <small class="text-muted">ğŸ“ˆ Per view</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sentiment Analysis Charts -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">ğŸ˜Š Comment Sentiment Analysis</h6>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 320px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="sentimentChart" style="max-width: 280px; max-height: 280px;"></canvas>
                    </div>
                    <div class="mt-3" style="font-size: 0.9rem;">
                        <div class="mb-1">
                            <span class="badge bg-success">âœ“ Positive: {{ sentiment_summary.positive_count }}</span>
                            <small class="text-muted">{{ sentiment_summary.positive_percentage }}%</small>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary">â†’ Neutral: {{ sentiment_summary.neutral_count }}</span>
                            <small class="text-muted">{{ sentiment_summary.neutral_percentage }}%</small>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-danger">âœ— Negative: {{ sentiment_summary.negative_count }}</span>
                            <small class="text-muted">{{ sentiment_summary.negative_percentage }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">â­ Comment Importance Breakdown</h6>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 320px;">
                        <canvas id="importanceChart"></canvas>
                    </div>
                    <div class="mt-3" style="font-size: 0.9rem;">
                        <div class="mb-1">
                            <span class="badge bg-danger">ğŸ”´ High Priority: {{ importance_breakdown.high }}</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-warning text-dark">ğŸŸ¡ Medium Priority: {{ importance_breakdown.medium }}</span>
                        </div>
                        <div class="mb-1">
                            <span class="badge bg-secondary">ğŸ”µ Low Priority: {{ importance_breakdown.low }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- High Importance Comments -->
    {% if high_importance_comments %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">ğŸ”´ High Priority Comments ({{ high_importance_comments|length }})</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">These comments deserve your attention - they are detailed, relevant feedback that can help improve your content.</p>
                    <div class="list-group">
                        {% for comment_analysis in high_importance_comments %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <strong>{{ comment_analysis.comment.author.get_full_name }}</strong>
                                        {% if comment_analysis.sentiment.sentiment == 'positive' %}
                                            <span class="badge bg-success">ğŸ˜Š Positive</span>
                                        {% elif comment_analysis.sentiment.sentiment == 'negative' %}
                                            <span class="badge bg-danger">ğŸ˜ Negative</span>
                                        {% else %}
                                            <span class="badge bg-secondary">ğŸ˜ Neutral</span>
                                        {% endif %}
                                    </h6>
                                    <p class="mb-1">{{ comment_analysis.comment.content }}</p>
                                    <small class="text-muted">
                                        Posted {{ comment_analysis.comment.created_at|date:"M d, Y" }} 
                                        | Sentiment Strength: {{ comment_analysis.sentiment.polarity|floatformat:2 }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Comments with Filtering -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">ğŸ’¬ All Comments ({{ total_comments }})</h5>
                </div>
                <div class="card-body">
                    {% if comments_analysis %}
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary active" data-filter="all">All Comments</button>
                        <button class="btn btn-sm btn-outline-success" data-filter="positive">ğŸ˜Š Positive</button>
                        <button class="btn btn-sm btn-outline-secondary" data-filter="neutral">ğŸ˜ Neutral</button>
                        <button class="btn btn-sm btn-outline-danger" data-filter="negative">ğŸ˜ Negative</button>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger" data-filter="high">ğŸ”´ High Priority</button>
                            <button class="btn btn-sm btn-outline-warning" data-filter="medium">ğŸŸ¡ Medium Priority (Improvements)</button>
                            <button class="btn btn-sm btn-outline-secondary" data-filter="low">ğŸ”µ Low Priority</button>
                        </div>
                    </div>

                    <div class="list-group">
                        {% for comment_analysis in comments_analysis %}
                        <div class="list-group-item comment-item" data-sentiment="{{ comment_analysis.sentiment.sentiment }}" data-importance="{{ comment_analysis.importance.importance }}">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="mb-1">
                                        <strong>{{ comment_analysis.comment.author.get_full_name }}</strong>
                                        {% if comment_analysis.sentiment.sentiment == 'positive' %}
                                            <span class="badge bg-success">ğŸ˜Š</span>
                                        {% elif comment_analysis.sentiment.sentiment == 'negative' %}
                                            <span class="badge bg-danger">ğŸ˜</span>
                                        {% else %}
                                            <span class="badge bg-secondary">ğŸ˜</span>
                                        {% endif %}

                                        {% if comment_analysis.importance.importance == 'HIGH' %}
                                            <span class="badge bg-danger">ğŸ”´</span>
                                        {% elif comment_analysis.importance.importance == 'MEDIUM' %}
                                            <span class="badge bg-warning text-dark">ğŸŸ¡</span>
                                        {% else %}
                                            <span class="badge bg-secondary">ğŸ”µ</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-1">{{ comment_analysis.comment.content }}</p>
                                    <small class="text-muted">
                                        Posted {{ comment_analysis.comment.created_at|date:"M d, Y" }} at {{ comment_analysis.comment.created_at|date:"H:i" }}
                                        | Sentiment Score: {{ comment_analysis.sentiment.polarity|floatformat:2 }}
                                    </small>
                                    {% if comment_analysis.importance.reason %}
                                    <div class="mt-1">
                                        <small class="text-info">ğŸ’¡ {{ comment_analysis.importance.reason }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No comments yet. Share your blog to get feedback! ğŸ“</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Info Card -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">ğŸ“„ Blog Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Category:</strong> {{ blog.category }}</p>
                            <p><strong>Status:</strong> 
                                {% if blog.status == 'published' %}
                                    <span class="badge bg-success">Published</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Draft</span>
                                {% endif %}
                            </p>
                            <p><strong>Created:</strong> {{ blog.created_at|date:"M d, Y" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Updated:</strong> {{ blog.updated_at|date:"M d, Y" }}</p>
                            <p><strong>Word Count:</strong> {{ blog.content|wordcount }} words</p>
                            <a href="{% url 'blog_detail' blog.slug %}" class="btn btn-sm btn-primary">View Blog</a>
                            <a href="{% url 'blog_edit' blog.slug %}" class="btn btn-sm btn-outline-primary">Edit Blog</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="row mb-4">
        <div class="col-md-12">
            <a href="{% url 'dashboard:analytics_dashboard' %}" class="btn btn-outline-secondary">â† Back to Analytics</a>
            <a href="{% url 'my_blogs' %}" class="btn btn-outline-primary">View All My Blogs</a>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    // Sentiment Chart
    const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
    const sentimentChart = new Chart(sentimentCtx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
                data: [
                    {{ sentiment_summary.positive_count }},
                    {{ sentiment_summary.neutral_count }},
                    {{ sentiment_summary.negative_count }}
                ],
                backgroundColor: ['#28a745', '#6c757d', '#dc3545'],
                borderColor: ['#fff', '#fff', '#fff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: false,
            width: 280,
            height: 280,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        font: { size: 11 },
                        boxWidth: 12
                    }
                }
            }
        }
    });

    // Importance Chart
    const importanceCtx = document.getElementById('importanceChart').getContext('2d');
    const importanceChart = new Chart(importanceCtx, {
        type: 'bar',
        data: {
            labels: ['High', 'Medium', 'Low'],
            datasets: [{
                label: 'Count',
                data: [
                    {{ importance_breakdown.high }},
                    {{ importance_breakdown.medium }},
                    {{ importance_breakdown.low }}
                ],
                backgroundColor: ['#dc3545', '#ffc107', '#6c757d'],
                borderColor: ['#c82333', '#e0a800', '#5a6268'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'x',
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Comment Filtering
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Update active button
            document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Filter comments
            document.querySelectorAll('.comment-item').forEach(item => {
                let show = false;

                if (filter === 'all') {
                    show = true;
                } else if (filter === 'positive' || filter === 'neutral' || filter === 'negative') {
                    show = item.getAttribute('data-sentiment') === filter;
                } else if (filter === 'high' || filter === 'medium' || filter === 'low') {
                    show = item.getAttribute('data-importance') === filter;
                }

                item.style.display = show ? '' : 'none';
            });
        });
    });
</script>

<style>
    .border-left-primary {
        border-left: 4px solid #007bff;
    }
    .border-left-danger {
        border-left: 4px solid #dc3545;
    }
    .border-left-info {
        border-left: 4px solid #17a2b8;
    }
    .border-left-success {
        border-left: 4px solid #28a745;
    }
</style>
{% endblock %}
